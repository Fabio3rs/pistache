# SPDX-FileCopyrightText: 2022 Andrea Pappacoda
#
# SPDX-License-Identifier: Apache-2.0

# See:
#   https://docs.github.com/en/actions/writing-workflows/choosing-where-your-workflow-runs/choosing-the-runner-for-a-job

name: Windows

on:
  push:
    branches:
    - master
    - windows
  pull_request:
    branches:
    - master
    - windows

defaults:
  run:
    shell: powershell

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  windows:
    name: Windows with Libevent

    strategy:
      fail-fast: false
      matrix:
        os: [ 'windows-2019', 'windows-latest' ] # Oct/2024, latest = 2022
        # compiler: [ 'msvc', 'gcc' ] # !!!!!!!!. Could also add clang
        compiler: [ 'msvc' ]
        sanitizer: [ 'address', 'undefined', 'none' ]
        tls: [ 'true', 'false' ]
        def_debug: [ 'true', 'false' ]
        exclude:
          # VS only supports address sanitizer as of Oct/2024
          - compiler: msvc
            sanitizer: undefined

    runs-on: ${{ matrix.os }}

    steps:
    - name: Install dependencies (Windows)
      env:
        mtrx_compiler: ${{ matrix.compiler }}
      if: contains(matrix.os, 'windows')
      run: >
        $savedpwd=$pwd
        
        # Save variables that we store to a file to be restored on next step
        
        $csvarray = @()
        
        # Start a Visual Studio Developer Prompt
        # As at Aug-2024, VS 2022, Launch-VsDevShell.ps1 defaults to
        # 32-bit host and target architectures. However you can specify
        # both target architecture (-Arch option, valid values: x86,
        # amd64, arm, arm64) and host architecture (-HostArch option,
        # valid values: x86, amd64)
        #
        # If we don't do this, then meson will pickup 32-bit as the host
        # and target architecture. Meanwhile, vcpkg defaults to 64-bit
        # libraries (since we're on a 64-bit Windows). So then the
        # linker can't link, because it is trying to link 64-bit vcpkg
        # libs with our 32-bit object files.
        #
        # Ref: https://learn.microsoft.com/en-us/visualstudio/
        #          ide/reference/command-prompt-powershell?view=vs-2022
        
        if (Test-Path -Path "$env:ProgramFiles/Microsoft Visual Studio") {
            cd "$env:ProgramFiles/Microsoft Visual Studio";
            $dirents=Get-ChildItem -Filter "????" -Name | Sort-Object -Descending -Property Name;
            foreach ($itm in $dirents) {
                if ("$itm" -match "^\d+$") {
                    $itm_as_num=$itm/1;
                    if ($itm_as_num -gt 1970) {
                        if (Test-Path "$itm/Enterprise/Common7/Tools/Launch-VsDevShell.ps1") {
                        $launch_vs_dev_shell_dir="$pwd\$itm\Enterprise\Common7\Tools";
                         break
                    }
                        elseif (Test-Path "$itm/Professional/Common7/Tools/Launch-VsDevShell.ps1") {
                            $launch_vs_dev_shell_dir="$pwd\$itm\Professional\Common7\Tools";
                            break
                        }
                        elseif (Test-Path "$itm/Community/Common7/Tools/Launch-VsDevShell.ps1") {
                            $launch_vs_dev_shell_dir="$pwd\$itm\Community\Common7\Tools";
                            break
                        }
                    }
                }
            }
            if (! ($launch_vs_dev_shell_dir)) {
            $launch_vs_dev_shell_dir = Get-ChildItem -Path "Launch-VsDevShell.ps1" -Recurse |
                Sort-Object -Descending -Property LastWriteTime |
                Select -Index 0 | Select -ExpandProperty "FullName" | Split-Path
            }
        }
         
        if ((! ($launch_vs_dev_shell_dir)) -or (! (Test-Path -Path $launch_vs_dev_shell_dir))) {
             Write-Host "Launch-VsDevShell.ps1 not found in $env:ProgramFiles/Microsoft Visual Studio";
             if (Test-Path -Path "${env:ProgramFiles(x86)}/Microsoft Visual Studio") {
                  Write-Host "Looking in ${env:ProgramFiles(x86)}/Microsoft Visual Studio";
                  cd "${env:ProgramFiles(x86)}/Microsoft Visual Studio";
                  $dirents=Get-ChildItem -Filter "????" -Name | Sort-Object -Descending -Property Name;
                  foreach ($itm in $dirents) {
                      if ("$itm" -match "^\d+$") {
                          $itm_as_num=$itm/1;
                          if ($itm_as_num -gt 1970) {
                              if (Test-Path "$itm/Enterprise/Common7/Tools/Launch-VsDevShell.ps1") {
                              $launch_vs_dev_shell_dir="$pwd\$itm\Enterprise\Common7\Tools";
                               break
                          }
                              elseif (Test-Path "$itm/Professional/Common7/Tools/Launch-VsDevShell.ps1") {
                                  $launch_vs_dev_shell_dir="$pwd\$itm\Professional\Common7\Tools";
                                  break
                              }
                              elseif (Test-Path "$itm/Community/Common7/Tools/Launch-VsDevShell.ps1") {
                                  $launch_vs_dev_shell_dir="$pwd\$itm\Community\Common7\Tools";
                                  break
                              }
                          }
                      }
                  }
                  if (! ($launch_vs_dev_shell_dir)) {
                      $launch_vs_dev_shell_dir = Get-ChildItem -Path "Launch-VsDevShell.ps1" -Recurse |
                          Sort-Object -Descending -Property LastWriteTime |
                          Select -Index 0 | Select -ExpandProperty "FullName" | Split-Path
                  }
             }
        }
              
        if (($launch_vs_dev_shell_dir) -And (Test-Path -Path $launch_vs_dev_shell_dir)) {
            cd "$launch_vs_dev_shell_dir";
            try {
                ./Launch-VsDevShell.ps1 -Arch amd64 -HostArch amd64
            } catch {
                Write-Host "Error in Launch-VsDevShell.ps1, checking Launch-VsDevShell.ps1's help";
                cd "$launch_vs_dev_shell_dir";
                if (! ((./Launch-VsDevShell.ps1 -?) -like "*-HostArch*")) {
                    Write-Host "Launch-VsDevShell.ps1 has no parameter -HostArch";
                    if (Test-Path -Path "${env:ProgramFiles(x86)}/Microsoft Visual Studio/Installer/vswhere.exe") {
                        Write-Host "Going to try Import-Module and Enter-VsDevShell";
                        cd "${env:ProgramFiles(x86)}/Microsoft Visual Studio/Installer";
                        $script:vs_instance_id=.\vswhere.exe -property instanceId;
                        cd "${env:ProgramFiles(x86)}/Microsoft Visual Studio";
                        $dirents=Get-ChildItem -Filter "????" -Name | Sort-Object -Descending -Property Name;
                        foreach ($itm in $dirents) {
                            if ("$itm" -match "^\d+$") {
                                $itm_as_num=$itm/1;
                                if ($itm_as_num -gt 1970) {
                                    if (Test-Path "$itm/Enterprise/Common7/Tools/Microsoft.VisualStudio.DevShell.dll") {
                                        $script:dev_shell_path="$pwd\$itm\Enterprise\Common7\Tools";
                                        break
                                }
                                    elseif (Test-Path "$itm/Professional/Common7/Tools/Microsoft.VisualStudio.DevShell.dll") {
                                        $script:dev_shell_path="$pwd\$itm\Professional\Common7\Tools";
                                        break
                                    }
                                    elseif (Test-Path "$itm/Community/Common7/Tools/Microsoft.VisualStudio.DevShell.dll") {
                                        $script:dev_shell_path="$pwd\$itm\Community\Common7\Tools";
                                        break
                                    }
                                }
                            }
                        }
                        if ("$dev_shell_path") {
                            $script:dev_shell_path="$dev_shell_path\Microsoft.VisualStudio.DevShell.dll"
                        }
                        else {
                            Write-Host "Searching for Microsoft.VisualStudio.DevShell.dll";
                            $script:dev_shell_path=Get-ChildItem -Path "Microsoft.VisualStudio.DevShell.dll" -Recurse |
                              Sort-Object -Descending -Property LastWriteTime |
                              Select -Index 0 |
                              Select -ExpandProperty "FullName"
                        }
                        if ($dev_shell_path) {
                            Import-Module "$dev_shell_path";
                            Write-Host (Get-Help Enter-VsDevShell);
                            $env:VSCMD_DEBUG=1;
                            Enter-VsDevShell -VsInstanceId $vs_instance_id -SkipAutomaticLocation -DevCmdDebugLevel Basic -DevCmdArguments '-arch=x64'
                        }
                        else {
                            Write-Error "ERROR: No Microsoft.VisualStudio.DevShell.dll"
                        }
                    }
                    else {
                        Write-Error "ERROR: vswhere.exe not found"
                    }
                }
                else {
                    Write-Error "ERROR: Unexpected Launch-VsDevShell.ps1 error"
                }
            }
        }
        else {
            Write-Error("ERROR: Launch-VsDevShell.ps1 not found")
        }

        $myobj = "" | Select "name", "val";
        $myobj.name = "launch_vs_dev_shell_dir";
        $myobj.val = $launch_vs_dev_shell_dir;
        $csvarray += $myobj

        if ($vs_instance_id) {
            $myobj = "" | Select "name", "val";
            $myobj.name = "vs_instance_id";
            $myobj.val = $vs_instance_id;
            $csvarray += $myobj
        }
        
        if ($dev_shell_path) {
            $myobj = "" | Select "name", "val";
            $myobj.name = "dev_shell_path";
            $myobj.val = $dev_shell_path;
            $csvarray += $myobj
        }

        if ($env:VSCMD_DEBUG) {
            $myobj = "" | Select "name", "val";
            $myobj.name = "env:VSCMD_DEBUG";
            $myobj.val = $env:VSCMD_DEBUG;
            $csvarray += $myobj
        }

        
        cd ~
          
        if (($env:VCPKG_INSTALLATION_ROOT) -and (Test-Path "$env:VCPKG_INSTALLATION_ROOT")) {
            $env:VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT
        }
        
        if ($env:VCPKG_ROOT) {
            $myobj = "" | Select "name", "val";
            $myobj.name = "env:VCPKG_ROOT";
            $myobj.val = $env:VCPKG_ROOT;
            $csvarray += $myobj
        }
        
        if ((! (Get-Command pkg-config -errorAction SilentlyContinue)) -or ((which pkg-config) -like "*Strawberry*"))
        { # meson does not accept the version of pkg-config in Strawberry Perl
        
            if (Get-Command winget -errorAction SilentlyContinue)
            { # winget exists on newer versions of Windows 10 and on
              # Windows 11 and after. It is is not supported on Windows
              # Server 2019, and is experimental only on Windows Server
              # 2022.
        
                winget install bloodrock.pkg-config-lite # For pkg-config
        
                # winget install Python # Already installed
            }
            else
            {
                vcpkg install pkgconf
            
            }
        }
        
        $old_pkg_config_path=$env:PKG_CONFIG_PATH;
        $env:PKG_CONFIG_PATH="$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\lib\pkgconfig";
        if ($old_pkg_config_path) {
            $env:PKG_CONFIG_PATH="$env:PKG_CONFIG_PATH;$old_pkg_config_path"
        }
        
        if (($env:VCPKG_INSTALLATION_ROOT) -And
            (Test-Path -Path "$env:VCPKG_INSTALLATION_ROOT\installed")) {
            # We add the ...\vcpkg\installed\...\bin dir to the path
    
            cd "$env:VCPKG_INSTALLATION_ROOT\installed"
            # Find ...\installed\...\bin directory. Choose shortest path
            # if more than one
            
            $vcpkg_installed_bin_dir=Get-ChildItem -Path "bin" -Recurse |
              Select -ExpandProperty "FullName" | Sort-Object { $_.Length } |
              Select -Index 0;
            if (($vcpkg_installed_bin_dir) -And
              (Test-Path -Path $vcpkg_installed_bin_dir)) {
                  $env:Path="$vcpkg_installed_bin_dir;$env:Path"
            }
            else {
                Write-Error "...\vcpkg\installed\...\bin directory not found"
            }

            $vcpkg_installed_pkgconf_dir=Get-ChildItem -Path "pkgconf.exe" -Recurse |
              Select -ExpandProperty "FullName" | Sort-Object { $_.Length } |
              Select -Index 0 | Split-Path;
            if (($vcpkg_installed_pkgconf_dir) -And
              (Test-Path -Path $vcpkg_installed_pkgconf_dir)) {
                  $env:Path="$vcpkg_installed_pkgconf_dir;$env:Path"
                  # Puts pkgconf.exe on the Path

                  if ((! (Get-Command pkg-config.exe -errorAction SilentlyContinue)) -or ((which pkg-config) -like "*Strawberry*"))
                  {
                      New-Item -ItemType SymbolicLink -Path "$vcpkg_installed_pkgconf_dir\pkg-config.exe" -Target "$vcpkg_installed_pkgconf_dir\pkgconf.exe"
                  }
            }

            cd ~
        }

        if (! (Get-Command meson -errorAction SilentlyContinue)) {
            pip3 install --user meson
        }

        if (! (Get-Command ninja -errorAction SilentlyContinue)) {
            # Try looking in known places in Microsoft Visual Studio
            
            if (Test-Path -Path "$env:ProgramFiles/Microsoft Visual Studio") {
                cd "$env:ProgramFiles/Microsoft Visual Studio";
                $dirents=Get-ChildItem -Filter "????" -Name | Sort-Object -Descending -Property Name;
                foreach ($itm in $dirents) {
                    if ("$itm" -match "^\d+$") {
                        $itm_as_num=$itm/1;
                        if ($itm_as_num -gt 1970) {
                            if (Test-Path "$itm/Enterprise/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja/ninja.exe") {
                            $script:ninja_dir="$pwd\$itm\Enterprise\Common7\IDE\CommonExtensions\Microsoft\CMake\Ninja";
                            break
                            }
                            elseif (Test-Path "$itm/Professional/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja/ninja.exe") {
                                $script:ninja_dir="$pwd\$itm\Professional\Common7\IDE\CommonExtensions\Microsoft\CMake\Ninja";
                                break
                            }
                            elseif (Test-Path "$itm/Community/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja/ninja.exe") {
                                $script:ninja_dir="$pwd\$itm\Community\Common7\IDE\CommonExtensions\Microsoft\CMake\Ninja";
                                break
                            }
                        }
                    }
                }
            }

            if ((! ($ninja_dir)) -or (! (Test-Path -Path $ninja_dir))) {
                # Try looking in known places in 32-bit Microsoft Visual Studio
                
                if (Test-Path -Path "${env:ProgramFiles(x86)}/Microsoft Visual Studio") {
                    cd "${env:ProgramFiles(x86)}/Microsoft Visual Studio";
                        $dirents=Get-ChildItem -Filter "????" -Name | Sort-Object -Descending -Property Name;
                    foreach ($itm in $dirents) {
                        if ("$itm" -match "^\d+$") {
                            $itm_as_num=$itm/1;
                            if ($itm_as_num -gt 1970) {
                                if (Test-Path "$itm/Enterprise/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja/ninja.exe") {
                                $script:ninja_dir="$pwd\$itm\Enterprise\Common7\IDE\CommonExtensions\Microsoft\CMake\Ninja";
                                break
                                }
                                elseif (Test-Path "$itm/Professional/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja/ninja.exe") {
                                    $script:ninja_dir="$pwd\$itm\Professional\Common7\IDE\CommonExtensions\Microsoft\CMake\Ninja";
                                    break
                                }
                                elseif (Test-Path "$itm/Community/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja/ninja.exe") {
                                    $script:ninja_dir="$pwd\$itm\Community\Common7\IDE\CommonExtensions\Microsoft\CMake\Ninja";
                                    break
                                }
                            }
                        }
                    }
                }
            }

            if ((! ($ninja_dir)) -or (! (Test-Path -Path $ninja_dir))) {
                # Try looking anywhere in 64-bit Microsoft Visual Studio
                if (Test-Path -Path "$env:ProgramFiles/Microsoft Visual Studio") {
                    cd "$env:ProgramFiles/Microsoft Visual Studio";
                    $script:ninja_dir = Get-ChildItem -Path "ninja.exe" -Recurse |
                      Sort-Object -Descending -Property LastWriteTime |
                      Select -Index 0 | Select -ExpandProperty "FullName" | Split-Path
                }
            }

            if ((! ($ninja_dir)) -or (! (Test-Path -Path $ninja_dir))) {
                # Try looking anywhere in 32-bit Microsoft Visual Studio
                
                if (Test-Path -Path "${env:ProgramFiles(x86)}/Microsoft Visual Studio") {
                    cd "${env:ProgramFiles(x86)}/Microsoft Visual Studio";
                    $script:ninja_dir = Get-ChildItem -Path "ninja.exe" -Recurse |
                        Sort-Object -Descending -Property LastWriteTime |
                        Select -Index 0 | Select -ExpandProperty "FullName" | Split-Path
                }
            }

            if ((! ($ninja_dir)) -or (! (Test-Path -Path $ninja_dir))) {
                # Can't find ninja in Microsoft Visual Studio, so install
            
                if (Get-Command winget -errorAction SilentlyContinue)
                {
                    winget install "Ninja-build.Ninja";
                }
                else
                {
                    vcpkg install vcpkg-tool-ninja

                    if (($env:VCPKG_INSTALLATION_ROOT) -And
                        (Test-Path -Path "$env:VCPKG_INSTALLATION_ROOT\installed")) {

                        cd "$env:VCPKG_INSTALLATION_ROOT\installed"
    
                        $script:ninja_dir=Get-ChildItem -Path "ninja.exe" -Recurse |
                          Select -ExpandProperty "FullName" | Sort-Object { $_.Length } |
                          Select -Index 0 | Split-Path;
                    }
                }
            }

            if (($ninja_dir) -And (Test-Path -Path $ninja_dir)) {
                $env:Path="$ninja_dir;$env:Path"
            }

            cd ~
        }

        vcpkg install curl[openssl]
        # See https://github.com/openssl/openssl/issues/25520 for now
        # As and when the issue is fixed, just do "vcpkg install
        # curl", which installs default curl that, on Windows, use
        # S-Channel not openssl.

        vcpkg install openssl # This can take some time
        
        vcpkg install libevent

        git clone https://github.com/google/googletest.git;
        cd googletest;
        mkdir build;
        cd build;
        cmake ..;
        cmake --build .;
        cmake --install . --config Debug;
        cd ~

        # Possible need to install powershell 7 (for pwsh.exe)
        # Or already installed?

        # Skip rapidjson which fails to build in one of the MSVC
        # cases. It's available as a subproject anyhow.
        # git clone https://github.com/Tencent/rapidjson/;
        # cd rapidjson/;
        # mkdir build;
        # cd build;
        # cmake ..;
        # cmake --build . --config Release;
        # cmake --install . --config Release

        vcpkg.exe install date # Howard-Hinnant-Date

        Invoke-WebRequest -Uri https://zlib.net/current/zlib.tar.gz -OutFile zlib.tar.gz;
        tar -xvzf .\zlib.tar.gz;
        cd "zlib*" # Adjusts to whatever we downloaded, e.g. zlib-1.3.1
        
        mkdir build;
        cd build;
        cmake ..;
        cmake --build . --config Release;
        cmake --install . --config Release

        if (! (Get-Command doxygen -errorAction SilentlyContinue)) {
            if (Get-Command winget -errorAction SilentlyContinue)
            { 
                winget install doxygen
            }
            else
            {
                cd ~;
                Invoke-WebRequest -Uri https://www.doxygen.nl/files/doxygen-1.12.0.windows.x64.bin.zip -OutFile doxygen.bin.zip;
                Expand-Archive doxygen.bin.zip -DestinationPath doxygen.bin;
                $env:Path="$env:Path;$env:USERPROFILE\doxygen.bin"
            }
        }

        if ($env:mtrx_compiler -eq "msvc") {
            $env:CXX="cl"
        }
        elseif ($env:mtrx_compiler -eq "gcc") {
            $env:CXX="g++" # Must put mingw-64 g++ compiler on Path
            
        }
        else { # Use clang with MSVC (MSVC's stdlib etc.)

            $env:CXX="clang-cl";
            $env:CXX_LD="lld"
        }
        $env:CC=$env:CXX

        if ($env:CXX) {
            $myobj = "" | Select "name", "val";
            $myobj.name = "env:CXX";
            $myobj.val = $env:CXX;
            $csvarray += $myobj
        }

        if ($env:CC) {
            $myobj = "" | Select "name", "val";
            $myobj.name = "env:CC";
            $myobj.val = $env:CC;
            $csvarray += $myobj
        }

        if ($env:CXX_LD) {
            $myobj = "" | Select "name", "val";
            $myobj.name = "env:CXX_LD";
            $myobj.val = $env:CXX_LD;
            $csvarray += $myobj
        }

        if (! (Get-Command meson -errorAction SilentlyContinue)) {
            if (Test-Path "~/AppData/Local/Packages") {
              cd "~/AppData/Local/Packages";
              $meson_exe_path = Get-ChildItem -Path "meson.exe" -Recurse |
                  Sort-Object -Descending -Property LastWriteTime |  
                  Select -Index 0 | Select -ExpandProperty "FullName" | Split-Path
            }

            if (((! ($meson_exe_path)) -or (! (Test-Path -Path $meson_exe_path))) -and (Test-Path "~/AppData/Roaming/Python")) {
              cd "~/AppData/Roaming/Python";
              $meson_exe_path = Get-ChildItem -Path "meson.exe" -Recurse |
                  Sort-Object -Descending -Property LastWriteTime |
                  Select -Index 0 | Select -ExpandProperty "FullName" | Split-Path
            }

            if (((! ($meson_exe_path)) -or (! (Test-Path -Path $meson_exe_path))) -and (Test-Path "~/AppData")) {
              cd "~/AppData";
              $meson_exe_path = Get-ChildItem -Path "meson.exe" -Recurse |
                  Sort-Object -Descending -Property LastWriteTime |
                  Select -Index 0 | Select -ExpandProperty "FullName" | Split-Path
            }

            if (($meson_exe_path) -And (Test-Path -Path $meson_exe_path)) {
                $env:Path="$env:Path;$meson_exe_path"
            }
            else {
                Write-Host "WARNING: meson.exe directory not added to path"
            }
        }

        # For pkg-config, we put the path segment for pkg-config.exe
        # at the head of the path, so meson finds our installed
        # pkg-config; whereas otherwise meson seems to find
        # C:\Strawberry\perl\bin\pkg-config.BAT first, and then meson
        # says "but it is Strawberry Perl and thus
        # broken. Ignoring...", and fails to find our pkg-config.

        if (($env:VCPKG_INSTALLATION_ROOT) -And
            (Test-Path -Path "$env:VCPKG_INSTALLATION_ROOT\installed")) {
            # We add the ...\vcpkg\installed\...\bin directory to the
            # path. Not only does this mean that executables can be executed
            # from that directory, it also allows DLLS to be loaded from that
            # bin directory (since Windows DLL loader checks path), notably
            # event_core.dll from libevent.
    
            cd "$env:VCPKG_INSTALLATION_ROOT\installed"
            # Find ...\installed\...\bin directory. Choose shortest path
            # if more than one
            
            $vcpkg_installed_bin_dir=Get-ChildItem -Path "bin" -Recurse |
              Select -ExpandProperty "FullName" | Sort-Object { $_.Length } |
              Select -Index 0;
            if (($vcpkg_installed_bin_dir) -And
              (Test-Path -Path $vcpkg_installed_bin_dir)) {
                  $env:Path="$vcpkg_installed_bin_dir;$env:Path"
            }
            else {
                Write-Error "...\vcpkg\installed\...\bin directory not found"
            }

            $vcpkg_installed_pkgconf_dir=Get-ChildItem -Path "pkgconf.exe" -Recurse |
              Select -ExpandProperty "FullName" | Sort-Object { $_.Length } |
              Select -Index 0 | Split-Path;
            if (($vcpkg_installed_pkgconf_dir) -And
              (Test-Path -Path $vcpkg_installed_pkgconf_dir)) {
                  $env:Path="$vcpkg_installed_pkgconf_dir;$env:Path"
                  # Puts pkgconf.exe on the Path

                }

            cd "$savedpwd"
        }

        if (Test-Path -Path "$env:USERPROFILE\doxygen.bin") {
            $env:Path="$env:Path;$env:USERPROFILE\doxygen.bin"
        }
        
        if ($env:PKG_CONFIG_PATH) {
            $myobj = "" | Select "name", "val";
            $myobj.name = "env:PKG_CONFIG_PATH";
            $myobj.val = $env:PKG_CONFIG_PATH;
            $csvarray += $myobj
        }
        
        if ($env:Path) {
            $myobj = "" | Select "name", "val";
            $myobj.name = "env:Path";
            $myobj.val = $env:Path;
            $csvarray += $myobj
        }
        
        # Save vars for use in later steps
        
        cd ~;
        $csvarray | export-csv "tmpvars.csv"
        
        cat "tmpvars.csv"
        

    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Configure Meson
      env:
        mtrx_compiler: ${{ matrix.compiler }}
        mtrx_def_debug: ${{ matrix.def_debug }}
        mtrx_tls: ${{ matrix.tls }}
        mtrx_sanitizer: ${{ matrix.sanitizer }}
      run: >
        $savedpwd=$pwd
        
        cd ~;
        $impcsv = import-csv -Path "tmpvars.csv";
        foreach ($impobj in $impcsv) {
            $impobj_name=$impobj.name;
            $impobj_val=$impobj.val;
            $assign_cmd=-join('$', "$impobj_name", '="', "$impobj_val", '"');
            echo "assign_cmd is $assign_cmd";
            Invoke-Expression "$assign_cmd"
        }

        # Start a Visual Studio Developer Prompt, gives access to compiler "cl"
        
        if (($dev_shell_path) -and (Test-Path -Path $dev_shell_path)) {
            Write-Host "Doing Import-Module and Enter-VsDevShell";
            Import-Module "$dev_shell_path";
            $env:VSCMD_DEBUG=1;
            Enter-VsDevShell -VsInstanceId $vs_instance_id -SkipAutomaticLocation -DevCmdDebugLevel Basic -DevCmdArguments '-arch=x64'
        }
        elseif (($launch_vs_dev_shell_dir) -and (Test-Path -Path $launch_vs_dev_shell_dir)) {
            cd "$launch_vs_dev_shell_dir";
            ./Launch-VsDevShell.ps1 -Arch amd64 -HostArch amd64
        }
        else {
            Write-Error "ERROR: Failed to start Visual Studio Developer Prompt"
        }

        # Import vars again in case starting dev prompt overwrote anything
        
        cd ~;
        $impcsv = import-csv -Path "tmpvars.csv";
        foreach ($impobj in $impcsv) {
            $impobj_name=$impobj.name;
            $impobj_val=$impobj.val;
            $assign_cmd=-join('$', "$impobj_name", '="', "$impobj_val", '"');
            echo "assign_cmd is $assign_cmd";
            Invoke-Expression "$assign_cmd"
        }

        cd "$savedpwd"

        meson setup build -DPISTACHE_BUILD_TESTS=true -DPISTACHE_DEBUG="$env:mtrx_def_debug" -DPISTACHE_USE_SSL="$env:mtrx_tls" -DPISTACHE_BUILD_EXAMPLES=true -DPISTACHE_BUILD_DOCS=false -DPISTACHE_USE_CONTENT_ENCODING_DEFLATE=true --buildtype=debug -Db_coverage=true -Db_sanitize="$env:mtrx_sanitizer" -Db_lundef=false

        if (Test-Path -Path 'build/meson-logs/meson-log.txt') {
            cat build/meson-logs/meson-log.txt
        }
        else {
            Write-Error "ERROR: No meson output log found"
        }

    - name: Build
      env:
        mtrx_compiler: ${{ matrix.compiler }}
      run: >
        $savedpwd=$pwd

        cd ~;
        $impcsv = import-csv -Path "tmpvars.csv";
        foreach ($impobj in $impcsv) {
            $impobj_name=$impobj.name;
            $impobj_val=$impobj.val;
            $assign_cmd=-join('$', "$impobj_name", '="', "$impobj_val", '"');
            echo "assign_cmd is $assign_cmd";
            Invoke-Expression "$assign_cmd"
        }

        # Start a Visual Studio Developer Prompt, gives access to compiler "cl"
        
        if (($dev_shell_path) -and (Test-Path -Path $dev_shell_path)) {
            Write-Host "Doing Import-Module and Enter-VsDevShell";
            Import-Module "$dev_shell_path";
            $env:VSCMD_DEBUG=1;
            Enter-VsDevShell -VsInstanceId $vs_instance_id -SkipAutomaticLocation -DevCmdDebugLevel Basic -DevCmdArguments '-arch=x64'
        }
        elseif (($launch_vs_dev_shell_dir) -and (Test-Path -Path $launch_vs_dev_shell_dir)) {
            cd "$launch_vs_dev_shell_dir";
            ./Launch-VsDevShell.ps1 -Arch amd64 -HostArch amd64
        }
        else {
            Write-Error "ERROR: Failed to start Visual Studio Developer Prompt"
        }

        # Import vars again in case starting dev prompt overwrote anything
        
        cd ~;
        $impcsv = import-csv -Path "tmpvars.csv";
        foreach ($impobj in $impcsv) {
            $impobj_name=$impobj.name;
            $impobj_val=$impobj.val;
            $assign_cmd=-join('$', "$impobj_name", '="', "$impobj_val", '"');
            echo "assign_cmd is $assign_cmd";
            Invoke-Expression "$assign_cmd"
        }

        cd "$savedpwd"

        ninja -C build

    - name: Test
      run: >
        $savedpwd=$pwd

        cd ~;
        $impcsv = import-csv -Path "tmpvars.csv";
        foreach ($impobj in $impcsv) {
            $impobj_name=$impobj.name;
            $impobj_val=$impobj.val;
            $assign_cmd=-join('$', "$impobj_name", '="', "$impobj_val", '"');
            echo "assign_cmd is $assign_cmd";
            Invoke-Expression "$assign_cmd"
        }

        # Start a Visual Studio Developer Prompt
        
        if (($dev_shell_path) -and (Test-Path -Path $dev_shell_path)) {
            Write-Host "Doing Import-Module and Enter-VsDevShell";
            Import-Module "$dev_shell_path";
            $env:VSCMD_DEBUG=1;
            Enter-VsDevShell -VsInstanceId $vs_instance_id -SkipAutomaticLocation -DevCmdDebugLevel Basic -DevCmdArguments '-arch=x64'
        }
        elseif (($launch_vs_dev_shell_dir) -and (Test-Path -Path $launch_vs_dev_shell_dir)) {
            cd "$launch_vs_dev_shell_dir";
            ./Launch-VsDevShell.ps1 -Arch amd64 -HostArch amd64
        }
        else {
            Write-Error "ERROR: Failed to start Visual Studio Developer Prompt"
        }

        # Import vars again in case starting dev prompt overwrote anything
        
        cd ~;
        $impcsv = import-csv -Path "tmpvars.csv";
        foreach ($impobj in $impcsv) {
            $impobj_name=$impobj.name;
            $impobj_val=$impobj.val;
            $assign_cmd=-join('$', "$impobj_name", '="', "$impobj_val", '"');
            echo "assign_cmd is $assign_cmd";
            Invoke-Expression "$assign_cmd"
        }

        cd "$savedpwd"

        meson test --no-rebuild -C build --verbose
        # Use the following to run just a single test (e.g. http_server_test)
        #   build/tests/run_http_server_test

    # No coverage analysis for Windows
